<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="js/util/string.js"></script>
        <script type="text/javascript" src="js/util/clock.js"></script>
        <script type="text/javascript" src="js/util/time.js"></script>
        <script type="text/javascript" src="js/canvas/graph.js"></script>
        <script type="text/javascript" src="js/data/constants.js"></script>
        <script type="text/javascript" src="js/data/telemetry.js"></script>

        <title>FH5T</title>
        <link rel="stylesheet" href="css/style.css">
    </head>

    <body>
        <script>
            const TELEMETRY_RPM = new Telemetry("RPM");

            function _update() {
                const xhttp = new XMLHttpRequest();
                xhttp.onload = function() {
                    //console.log("update: "+this.responseText);
                    var token = this.responseText.split(" ");
                    var race = document.getElementById("race");
                    if(token[0] == "1") {
                        race.style.backgroundColor = "#30FF30";
                    }
                    else {
                        race.style.backgroundColor = "crimson";
                    }

                    // === RPM ===
                    var maxRpmLabel = document.getElementById("rpm-max");
                    var sMaxRpm = token[DATA_INDEX_RPM_MAX];
                    var sCurRpm = token[DATA_INDEX_RPM_CURRENT];
                    maxRpmLabel.innerHTML = sMaxRpm; 
                    TELEMETRY_RPM.sample(parseInt(sCurRpm));
                    var rpmCanvas = document.getElementById("rpm-canvas");
                    drawTelemetryAsBars(TELEMETRY_RPM, rpmCanvas, parseInt(sMaxRpm));
                    update();
                }                
                xhttp.open("GET", "datagram", true);
                xhttp.send();
            }

            function update() {
                setTimeout(_update,10);
            }


            window.onbeforeunload = function(){
                const xhttp = new XMLHttpRequest();
                xhttp.open("GET", "stop-server", true);
                xhttp.send();
             }
            window.onload = function() {
                var canvas1 = document.getElementById("canvas-1");
                var canvas2 = document.getElementById("canvas-2");
                var canvas3 = document.getElementById("canvas-3");
                var canvas4 = document.getElementById("canvas-4");
                var canvas5 = document.getElementById("canvas-5");
                var canvas6 = document.getElementById("canvas-6");

                startclock();

                update();

                function receiveData() {
                    //TELEMETRY_RPM.sample(Math.random());
                    drawTelemetryAsBars(TELEMETRY_RPM, canvas2, TELEMETRY_RPM.max);
                    drawTelemetryAsBars(TELEMETRY_RPM, canvas3, TELEMETRY_RPM.max);
                    drawTelemetryAsBars(TELEMETRY_RPM, canvas4, TELEMETRY_RPM.max);
                    drawTelemetryAsBars(TELEMETRY_RPM, canvas5, TELEMETRY_RPM.max);
                    drawTelemetryAsBars(TELEMETRY_RPM, canvas6, TELEMETRY_RPM.max);
                }

                setInterval(receiveData,30);
            };

            /* DEMO: function loadDoc() {
                const xhttp = new XMLHttpRequest();
                xhttp.onload = function() {
                    document.getElementById("demo").innerHTML = this.responseText;
                }
                xhttp.open("GET", "ajax_info.txt", true);
                xhttp.send();
            }*/
        </script>

        <div class="header">
            FH5T - Forza Horizon 5 Telemetry
            <div class="maincontrol">
                <script>
                    function exit() {
                        const xhttp = new XMLHttpRequest();
                        xhttp.open("GET", "stop-server", true);
                        xhttp.send();
                        document.getElementById("content").innerHTML = '<div class="banner">Process stopped</div>';
                        setTimeout(function() {
                            window.close();
                        }, 2000);
                    }
                </script>
                <div id="race">

                </div>
                <div id="clock">
                    00:00:00
                </div>                
                <button type="button" class="maincontrol" onclick="exit()">Exit</button>    
            </div>
        </div>

        <div  id="content">
            <div class="telemetry-container">
                <p class="telemetry-title">RPM</p>
                <div>
                    <div class="label">
                            <p class="top-label" id="rpm-max">00000</p>
                            <p class="bottom-label">0</p>
                        </p>
                    </div>
                    <canvas class="telemetry" id="rpm-canvas" width="800" height="150"></canvas>
                </div>
            </div>
            <div class="telemetry-container">
                <p class="telemetry-title">Reserved</p>
                <div>
                    <div class="label">
                            <p class="top-label">00000</p>
                            <p class="bottom-label">0</p>
                        </p>
                    </div>
                    <canvas class="telemetry" id="canvas-2" width="800" height="150"></canvas>                
                </div>    
            </div>
            <div class="telemetry-container">
                <p class="telemetry-title">Reserved</p>
                <div>
                    <div class="label">
                            <p class="top-label">00000</p>
                            <p class="bottom-label">0</p>
                        </p>
                    </div>
                    <canvas class="telemetry" id="canvas-3" width="800" height="150"></canvas>
                </div>
            </div>    
            <div class="telemetry-container">
                <p class="telemetry-title">Reserved</p>
                <div>
                    <div class="label">
                            <p class="top-label">00000</p>
                            <p class="bottom-label">0</p>
                        </p>
                    </div>                
                    <canvas class="telemetry" id="canvas-4" width="800" height="150"></canvas>
                </div>
            </div>    
            <div class="telemetry-container">
                <p class="telemetry-title">Reserved</p>
                <div>
                    <div class="label">
                            <p class="top-label">00000</p>
                            <p class="bottom-label">0</p>
                        </p>
                    </div>
                    <canvas class="telemetry" id="canvas-5" width="800" height="150"></canvas>
                </div>
            </div>    
            <div class="telemetry-container">
                <p class="telemetry-title">Reserved</p>
                <div>
                    <div class="label">
                            <p class="top-label">00000</p>
                            <p class="bottom-label">0</p>
                        </p>
                    </div>
                    <canvas class="telemetry" id="canvas-6" width="800" height="150"></canvas>
                </div>
            </div>    
        </div>  
    </body>
</html>
